name: Generaci贸n PDF Asciidoctor

on:
  push:
    branches:
      - main

jobs:
  build-pdfs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout del repositorio
        uses: actions/checkout@v4

      - name: Configurar Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: Instalar Asciidoctor PDF
        run: gem install asciidoctor-pdf --no-document

      - name: Verificar instalaci贸n de Asciidoctor PDF
        run: |
          which asciidoctor-pdf
          asciidoctor-pdf --version

      - name: Configurar Python para traducci贸n
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Instalar librer铆a de traducci贸n
        run: pip install googletrans==4.0.0-rc1

      - name: Crear directorio de PDFs y temporal para traducci贸n
        run: mkdir -p pdf tmp_en

      - name: Generar PDFs Espa帽ol e Ingl茅s autom谩ticamente
        run: |
          ASCIIDOCTOR=$(which asciidoctor-pdf)

          for dir in */ ; do
            if [ -f "$dir/index.adoc" ]; then
              NAME="${dir%/}"

              echo "Generando PDF espa帽ol para $NAME..."
              (cd "$dir" && "$ASCIIDOCTOR" index.adoc -o "../pdf/es_${NAME}.pdf")

              # Traducir los .adoc a ingl茅s
              TMP_DIR="../tmp_en/$NAME"
              mkdir -p "$TMP_DIR"
              for file in $(find "$dir" -name "*.adoc"); do
                REL_PATH=$(realpath --relative-to="$dir" "$file")
                OUT_FILE="$TMP_DIR/$REL_PATH"
                mkdir -p "$(dirname "$OUT_FILE")"
                python3 - <<EOF
                from googletrans import Translator
                text = open("$file", "r", encoding="utf-8").read()
                translated = Translator().translate(text, src='es', dest='en').text
                open("$OUT_FILE", "w", encoding="utf-8").write(translated)
                EOF
              done

              # Generar PDF ingl茅s
              echo "Generando PDF ingl茅s para $NAME..."
              (cd "$TMP_DIR" && "$ASCIIDOCTOR" index.adoc -o "../../pdf/en_${NAME}.pdf")
            fi
          done

      - name: Crear body del release
        run: |
          echo "##  PDFs generados autom谩ticamente" > release_body.md
          echo "" >> release_body.md
          echo "![Release Image](.github/media/released.png)" >> release_body.md
          echo "### Documentaci贸n disponible:" >> release_body.md
          echo "" >> release_body.md
          for pdf in pdf/*.pdf; do
            echo "- $(basename "$pdf")" >> release_body.md

      - name: Borrar todos los tags remotos
        run: |
          echo "Obteniendo todos los tags remotos..."
          tags=$(git ls-remote --tags origin | awk '{print $2}' | sed 's#refs/tags/##' | grep -v '\^{}')
          if [ -z "$tags" ]; then
            echo "No hay tags para borrar."
          else
            for tag in $tags; do
              echo "Borrando tag remoto: $tag"
              git push origin --delete "$tag"
            done
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Eliminar releases anteriores
        run: |
          echo "Eliminando releases anteriores..."
          releases=$(gh release list --limit 100 --json tagName -q '.[].tagName')
          
          if [ -z "$releases" ]; then
            echo "No hay releases anteriores que eliminar."
          else
            for r in $releases; do
              echo "Borrando release $r..."
              gh release delete "$r" --yes || echo "Error eliminando $r, continuando..."
            done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Crear Release y subir PDFs
        uses: softprops/action-gh-release@v1
        with:
          tag_name: docs-pdf-${{ github.run_number }}
          name: " Docs Descargables PDF "
          body_path: release_body.md
          files: pdf/*.pdf
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}