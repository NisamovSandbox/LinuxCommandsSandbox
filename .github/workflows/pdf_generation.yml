name: Generaci√≥n PDF Asciidoctor

on:
  push:
    branches:
      - main

jobs:
  build-pdfs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout del repositorio
        uses: actions/checkout@v4

      - name: Configurar Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: Instalar Asciidoctor PDF
        run: gem install asciidoctor-pdf --no-document

      - name: Instalar Rouge (dependencia de Asciidoctor PDF)
        run: gem install rouge --no-document

      - name: Verificar instalaci√≥n de Asciidoctor PDF
        run: |
          which asciidoctor-pdf
          asciidoctor-pdf --version

      - name: Configurar Python para traducci√≥n
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Instalar librer√≠a de traducci√≥n
        run: pip install deep-translator

      - name: Crear directorios
        run: mkdir -p pdf tmp_en

      - name: Generar PDFs Espa√±ol e Ingl√©s
        run: |
          set -e
          ASCIIDOCTOR=$(which asciidoctor-pdf)
          mkdir -p pdf tmp_en

          for dir in */ ; do
            if [ -f "$dir/index.adoc" ]; then
              NAME="${dir%/}"
              
              echo "Generando PDF espa√±ol para $NAME..."
              (cd "$dir" && "$ASCIIDOCTOR" index.adoc -o "../pdf/ESP_${NAME}.pdf")

              echo "Preparando versi√≥n en ingl√©s..."
              TMP_DIR="tmp_en/$NAME"
              mkdir -p "$TMP_DIR"

              # Copiar todo el m√≥dulo manteniendo estructura y subdirectorios
              rsync -av "$dir"/ "$TMP_DIR"/

              # Traducir todos los archivos .adoc in-place dentro de TMP_DIR
              python3 .github/scripts/translate_adoc.py "$TMP_DIR" "$TMP_DIR"

              echo "Generando PDF ingl√©s para $NAME..."
              if [ -f "$TMP_DIR/index.adoc" ]; then
                (cd "$TMP_DIR" && "$ASCIIDOCTOR" index.adoc -o "../../pdf/ENG_${NAME}.pdf")
              else
                echo "ERROR: index.adoc no encontrado en $TMP_DIR"
              fi

              # Verificar PDF ingl√©s
              if [ ! -f "pdf/en_${NAME}.pdf" ]; then
                echo "ERROR: PDF ingl√©s para $NAME no se gener√≥ correctamente."
              fi
            fi
          done

          echo ""
          echo "PDFs generados:"
          ls -l pdf/

      - name: Crear body del release
        run: |
          {
            echo "## üìï PDFs generados autom√°ticamente"
            echo ""
            echo "![Release Image](.github/media/released.png)"
            echo ""
            echo "<details open>"
            echo "<summary><strong>‚Ä¢ Documentaci√≥n ESP</strong></summary>"
            echo ""
            for pdf in pdf/ESP_*.pdf; do
              [ -e "$pdf" ] || continue
              echo "- $(basename "$pdf")"
            done
            echo ""
            echo "</details>"
            echo ""
            echo "<details open>"
            echo "<summary><strong>‚Ä¢ Documentation ENG</strong></summary>"
            echo ""
            for pdf in pdf/ENG_*.pdf; do
              [ -e "$pdf" ] || continue
              echo "- $(basename "$pdf")"
            done
            echo ""
            echo "</details>"
          } > release_body.md

          cat release_body.md

      - name: Borrar todos los releases existentes
        run: |
          set -e

          REPO="${{ github.repository }}"
          PAGE=1
          echo "Eliminando todos los releases del repositorio $REPO ..."
          while true; do
            echo "Consultando p√°gina $PAGE..."
            RELEASE_IDS=$(curl -s \
              -H "Authorization: Bearer $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/$REPO/releases?per_page=100&page=$PAGE" \
              | jq -r '.[].id')

            if [ -z "$RELEASE_IDS" ]; then
              echo "No hay m√°s releases."
              break
            fi

            for ID in $RELEASE_IDS; do
              echo "Borrando release ID: $ID"
              curl -s -X DELETE \
                -H "Authorization: Bearer $GITHUB_TOKEN" \
                -H "Accept: application/vnd.github+json" \
                "https://api.github.com/repos/$REPO/releases/$ID"
            done
            PAGE=$((PAGE + 1))
          done
          echo "Todos los releases han sido eliminados correctamente."
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Borrar todos los tags remotos
        run: |
          set +e
          echo "Obteniendo todos los tags remotos..."
          tags=$(git ls-remote --tags origin | awk '{print $2}' | sed 's#refs/tags/##' | grep -v '\^{}')
          if [ -z "$tags" ]; then
            echo "No hay tags para borrar."
          else
            for tag in $tags; do
              echo "Intentando borrar tag remoto: $tag"
              git push origin --delete "$tag" || echo "No se pudo borrar $tag, continuando..."
            done
          fi
          set -e
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Crear Release y subir PDFs
        uses: softprops/action-gh-release@v1
        with:
          tag_name: docs-pdf-${{ github.run_number }}
          name: "üîµ Docs Descargables PDF üìï"
          body_path: release_body.md
          files: pdf/*.pdf
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}