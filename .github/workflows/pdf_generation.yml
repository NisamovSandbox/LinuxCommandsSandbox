name: GeneraciÃ³n PDF Asciidoctor

on:
  push:
    branches:
      - main

jobs:
  build-pdfs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout del repositorio
        uses: actions/checkout@v4

      - name: Configurar Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: Instalar Asciidoctor PDF y dependencias
        run: |
          gem install asciidoctor-pdf --no-document
          gem install rouge --no-document

      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Instalar librerÃ­a de traducciÃ³n
        run: pip install deep-translator

      - name: Crear directorios temporales y de PDFs
        run: mkdir -p tmp_en tmp_zh pdf

      - name: Generar PDFs ESP, ENG y ZH
        run: |
          set -e
          ASCIIDOCTOR=$(which asciidoctor-pdf)

          # Buscar todas las carpetas con index.adoc en el repo
          find . -type f -name "index.adoc" | while read INDEX; do
            DIR=$(dirname "$INDEX")
            NAME=$(basename "$DIR")
            echo "=== Procesando mÃ³dulo: $NAME ==="
            echo "Generando PDF EspaÃ±ol..."
            "$ASCIIDOCTOR" "$DIR/index.adoc" -o "pdf/ESP_${NAME}.pdf"
            echo "Generando PDF InglÃ©s..."
            TMP_EN="tmp_en/$NAME"
            mkdir -p "$TMP_EN"
            rsync -a "$DIR/" "$TMP_EN/"
            python3 .github/scripts/translate_adoc.py "$TMP_EN" "$TMP_EN" en
            "$ASCIIDOCTOR" "$TMP_EN/index.adoc" -o "pdf/ENG_${NAME}.pdf"
            echo "Generando PDF Chino..."
            TMP_ZH="tmp_zh/$NAME"
            mkdir -p "$TMP_ZH"
            rsync -a "$DIR/" "$TMP_ZH/"
            python3 .github/scripts/translate_adoc.py "$TMP_ZH" "$TMP_ZH" zh-CN
            "$ASCIIDOCTOR" \
              -a pdf-theme=.github/themes/theme-zh.yml \
              -a pdf-fontsdir=.github/fonts \
              "$TMP_ZH/index.adoc" \
              -o "pdf/ZH_${NAME}.pdf"
          done

      - name: Crear body del release
        run: |
          {
            echo "## ðŸ“• PDFs generados automÃ¡ticamente"
            echo ""
            echo "<details open>"
            echo "<summary><strong>â€¢ DocumentaciÃ³n ESP</strong></summary>"
            echo ""
            for pdf in pdf/ESP_*.pdf; do [ -e "$pdf" ] || continue; echo "- $(basename "$pdf")"; done
            echo "</details>"
            echo ""
            echo "<details open>"
            echo "<summary><strong>â€¢ Documentation ENG</strong></summary>"
            echo ""
            for pdf in pdf/ENG_*.pdf; do [ -e "$pdf" ] || continue; echo "- $(basename "$pdf")"; done
            echo "</details>"
            echo ""
            echo "<details open>"
            echo "<summary><strong>â€¢ æ–‡æ¡£ ä¸­æ–‡ï¼ˆç®€ä½“ï¼‰</strong></summary>"
            echo ""
            for pdf in pdf/ZH_*.pdf; do [ -e "$pdf" ] || continue; echo "- $(basename "$pdf")"; done
            echo "</details>"
          } > release_body.md

      - name: Borrar releases existentes
        run: |
          set -e
          REPO="${{ github.repository }}"
          PAGE=1
          while true; do
            IDS=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" \
              "https://api.github.com/repos/$REPO/releases?per_page=100&page=$PAGE" | jq -r '.[].id')
            [ -z "$IDS" ] && break
            for ID in $IDS; do
              curl -s -X DELETE -H "Authorization: Bearer $GITHUB_TOKEN" \
                "https://api.github.com/repos/$REPO/releases/$ID"
            done
            PAGE=$((PAGE + 1))
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Crear Release y subir PDFs
        uses: softprops/action-gh-release@v1
        with:
          tag_name: docs-pdf-${{ github.run_number }}
          name: "ðŸ“˜ DocumentaciÃ³n PDF"
          body_path: release_body.md
          files: pdf/*.pdf
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
