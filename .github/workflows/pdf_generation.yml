name: Generaci칩n PDF Asciidoctor

on:
  schedule:
    # Ejecutar los lunes y viernes a medianoche
    - cron: '0 0 * * 1,5'
  workflow_dispatch:

jobs:
  build-pdfs:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout del repositorio
        uses: actions/checkout@v4

      - name: Configurar Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: Instalar Asciidoctor PDF y dependencias
        run: |
          gem install asciidoctor-pdf --no-document
          gem install rouge --no-document

      - name: Instalar GitHub CLI
        run: sudo apt-get update && sudo apt-get install -y gh

      - name: Configurar Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Instalar librer칤a de traducci칩n
        run: pip install deep-translator

      - name: Crear directorios temporales y de PDFs
        run: mkdir -p tmp_en tmp_de pdf

      - name: Listar y borrar tags
        run: |
          TAGS=$(git tag)
          if [ -z "$TAGS" ]; then
            echo "No hay tags que borrar."
          else
            echo "Borrando tags locales..."
            git tag -d $TAGS || true
            echo "Borrando tags remotos..."
            for TAG in $TAGS; do
              git push origin :refs/tags/$TAG || true
            done
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
      - name: Borrar releases existentes
        run: |
          set -e
          REPO="${{ github.repository }}"
          PAGE=1
          while true; do
            IDS=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" \
              "https://api.github.com/repos/$REPO/releases?per_page=100&page=$PAGE" | jq -r '.[].id')
            [ -z "$IDS" ] && break
            for ID in $IDS; do
              [ -z "$ID" ] && continue
              curl -s -X DELETE -H "Authorization: Bearer $GITHUB_TOKEN" \
                "https://api.github.com/repos/$REPO/releases/$ID" || true
            done
            PAGE=$((PAGE + 1))
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generar PDFs ESP, ENG y DE
        run: |
          set -e
          ASCIIDOCTOR=$(which asciidoctor-pdf)

          find . -type f -name "index.adoc" | while read INDEX; do
            DIR=$(dirname "$INDEX")
            NAME=$(basename "$DIR")
            echo "=== Procesando m칩dulo: $NAME ==="

            # Espa침ol
            echo "Generando PDF Espa침ol..."
            "$ASCIIDOCTOR" "$DIR/index.adoc" -o "pdf/ESP_${NAME}.pdf"

            # Ingl칠s
            TMP_EN="tmp_en/$NAME"
            mkdir -p "$TMP_EN"
            rsync -a "$DIR/" "$TMP_EN/"
            python3 .github/scripts/translate_adoc.py "$TMP_EN" "$TMP_EN" en
            "$ASCIIDOCTOR" "$TMP_EN/index.adoc" -o "pdf/ENG_${NAME}.pdf"
            
            # Alem치n
            TMP_DE="tmp_de/$NAME"
            mkdir -p "$TMP_DE"
            rsync -a "$DIR/" "$TMP_DE/"
            python3 .github/scripts/translate_adoc.py "$TMP_DE" "$TMP_DE" de
            "$ASCIIDOCTOR" "$TMP_DE/index.adoc" -o "pdf/DE_${NAME}.pdf"
          done

      - name: Crear releases por idioma
        run: |
          echo "Creando releases separados por idioma..."
          for LANG in DE ENG ESP; do
            FILES=$(ls pdf/${LANG}_*.pdf | tr '\n' ' ')
            echo "Archivos $LANG: $FILES"
            IMAGE_URL="https://raw.githubusercontent.com/${{ github.repository }}/main/.github/media/released_${LANG}.png"
            gh release create $LANG $FILES \
              --title "游댯 Documentaci칩n PDF $LANG 游늿" \
              --notes "![Release Image]($IMAGE_URL)"
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}